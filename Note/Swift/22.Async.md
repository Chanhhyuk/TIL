# Async(비동기)

** 화면주사율**
아이폰의 화면 주사율 60Hz
1초에 60번 화면을 다시 그린다
비동기 처리를 하지 않으면 이런 매커니즘이 제대로 동작하지 못하기 때문에 화면이 버벅거림

- 1.0 GHz(1코어): 1초에 10억번 연산
- Thread 1 (메인 쓰레드)

Serial(직렬처리) - 순서가 중요한 작업을 처리할 때
Cocurrent(동시처리) - 독립적이지만 유사한 여러개의 작업을 처리할 때
서버에 데이터를 요청하는(네트워크 통신) 일은 부하가 많이 걸리는 일

**앱의 시작과정**
user app icon: 아이콘 클릭
main(): 메인함수 실행
UIApplicationMain(): 앱 하나를 전체적으로 관리하는 객체 생성
Load UI: 화면준비

- 메인런루프(무한반복문)
- DispatchQueue 
- OperationQueue: 되게 어렵, 실무에서 잘 사용안함, DispatchQueue먼저 이해하면 수월함

Thread는 물리적인것과 소프트웨어적인것은 다르다
- 물리적인 Thread: 실제 컴퓨터에 붙어 있는 부품 ex) 8코어 16쓰레드
- 소프트웨어적인 Thread: 객체

병렬: 물리적인 Thread 
동시성: 소프트웨어적인 Thread

## 동기 비동기 개념
- 비동기: 어떤작업을 Queue에 보내고 보낸 시점이 있고, Queue가 자동으로 다른 쓰레드에 일을 보낼때 바로 즉시 리턴하는것
- 비동기 Async 작업이 다른 쓰레드에서 하도록 시킨 후, 그 작업이 끝나길 안기다리고 다음일 진행

- 동기Sync: 작업이 다른 쓰레드에서 하도록 시킨 후, 그 작업이 끝나길 기다렸다가 다음일을 진행

Swift는 동기는 Blocking 비동기는 Non - Blocking만 쓰임

## 직렬과 동시의 개념
- Dispatch: 보내다
- DispatchQueue: 쓰레드를 관리하는 객체
- 일은 나눠서해도 실제로 출력되는일은 메인스레드에서만 일어남 

## GCD
- 이름이 global()인것 뿐 보통 이렇게 사용한다./ 개발자들이 자주 사용하라고 애플이 미리 만들어놈
- global()큐도 여러 종류가 있다.
- 서비스의 품질이 높을수록 여러개의 Thread를 사용
- 글로벌큐 디폴드값은 중간단계의 서비스품질을 가지고 있음

## GCD 주의점
- 메인스레드가 아닌 스레드에서 작업후 UI는 메인쓰레드로 보내야 한다
- 메인스레드는 화면을 (다시) 그리는일을 하기 때문
- URLSession은 내부적으로 비동기처리가 되어있다
- 그래서 URLSession 자체가 global() 큐에서 돌아가고 있다.
- 그렇다면 UI가 필요없는 작업이면 따로 main큐는 필요가 없는건가?
- 비동기 작업은 일반함수를 사용하는게 아닌 콜백함수를 통해서 작업이 끝난다음의 결과를 받아야 한다.
- 왜냐하면 일반함수는 작업을 하고 return을 하는데 비동기는 보내자마자 (결과와 상관없이) 바로 return을 받으므로
- 일반함수로 설계할 경우 항상 nil이 나옴
- photoImage를 completionHandler라는 클로저를 실행. 던져주고 있다 // 콜백함수를 실행하고 있다.
- completionHandler: 비동기적인걸 전부 실행시킨다음에 다 끝나면 그 결과값으로 클로저로 실행하겠다.

## GCD [weak, strong]
- doSomething의 self가 강하게 붙잡아 두고 있음
- else 옆에 있는 self가 [weak self]이고 ViewController1을 가르키는데 self가 옵셔널바인딩으로 없어졌으니까 글로벌큐에서 출력하지 않겠다는 의미???
- 일반적으로는 guard let self = self else로 써야됨 앞에있는 셀프에 뭘 따로 써야함
- 리턴형이 없는경우는 상관없지만 리턴형이 있는경우 리턴형식을 전달하기위해 클로저로 설계함

## Async/await
- 비동기는 즉시 return 하기 때문에 일반적인 함수를 사용하면 안된다.
- 비동기를 클로저함수로 실행하면 단점은 작업이 끝난 후 UI를 메인에 전달하기위해 다시 클로저를 실행한다
- 비동기함수가 여러개 뭉쳐있을 때 pyramid of doom 으로 계속 들여써야 된다.
- 그래서 자바스크립트에서 기능을 들임
- 함수를 만들때 return형 앞에 async를 붙여줌 그러면 return방식으로 설계해도 됨
- await: 비동기가 다 실행될때 까지 기다려준다 / return을 받을수 있기떄문에 들여쓰기를 안해도 된다.

## 동시성 프로그래밍의 메모리 구조
- 각각의 쓰레드는 독립적인 Stack을 사용 때문에(즉 사용하는 메모리가 다르다) 각각의 쓰레드는 다른 쓰레드의 값을 사용못함
- 하지만 코데힙 영역은 공유를 한다.
- 각각의 쓰레드가 각자의 일을 하고 있다가 데이터나 힙에 동시에 접근하는것 (경쟁상황)
- Thread-safe하지 않는다고 말하기도 함
- DeadLock: 이것도 동시에 접근하는 개념인데 상대쓰레드에서 먼저 사용하기위해 힙의 데이터를 잠궈버리면 나?의 쓰레드에서는 접근할 수 없을때

## 해결책
- 동시에 접근할 때 serial 큐에 보낸다 serial큐는 반드시 하나밖에 일을 못한다.
- 빈 array는 메모리가 하나지만 여러 쓰레드에서 접근하고 있음
- asyncAfter: 비동기적으로 실행할건데 몇초후에 실행해라는 메서드
- 1부터 20까지 하나의 메모리(빈 배열)에 접근함 출력해보면 여러개가 동시에 하나의 메모리에 접근하기 때문에 없는 값이 몇개 있음
- serialQueue로 접근하면 한번에 하나씩만 없는 값 없이 잘 출력됨
- 경쟁상황을 해결할수 있는 방법
